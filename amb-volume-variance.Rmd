---
output:
  html_document:
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
    fig_width: 7
    fig_height: 6
---


<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: 0;
  margin-right: auto;
}
</style>

<style>
.tocify {
color: black;
}
<!-- } -->
<!-- .tocify .tocify-header { -->
<!--     position: fixed; -->
<!--     <!-- top: 50px; --> -->
<!--     left: 50px; -->
<!--     width: 350px; -->
<!--     <!-- border: solid 3px black; --> -->
<!--     <!-- height: 200px; --> -->
<!--  border: none; -->
<!-- } -->
.tocify .tocify-header .active {
color: white;
background: #d80b8c;
font-weight: bold;
}
<!-- .tocify .tocify-item { -->
<!-- background: white; -->
<!-- color: black; -->
<!--  border: none; -->
<!-- } -->
</style>


<style>
  .nav-pills>li>a:hover, .nav-pills>li>a:focus, .nav-pills>li.active>a,     .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus{
     background-color: #210070;
     }
</style>

<style>
.container { width: 1800px; }
h2 {
  background-color: #dddedd;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h3 {
  background-color: #f2f2f2;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h4 {
  <!-- background-color: #dddedd; -->
  <!-- color: black; -->
  text-indent: 50px;
  <!-- font-weight: bold; -->
}
</style>

<style>
.blackbox {
  padding: 1em;
  background: white;
  color: black;
  border: 2px solid #7f7f7f;
  width: 100%;
  position: center;
  align: center;
  margin: 0px auto;
}
.center {
  text-align: left;
  margin: 0px auto;
}
</style>


<!-- ```{css toc-content, echo = FALSE} -->
<!-- #TOC { -->
<!--   right: 270px; -->
<!--   margin: 20px 0px 25px 0px; -->
<!-- } -->

<!-- .main-container { -->
<!--     margin-left: 200px; -->
<!-- } -->
<!-- ``` -->


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r Load Packages, echo = FALSE, warning = FALSE, message = FALSE}

# # Load packages -----------------------------------------------------------------------------------
suppressMessages({
  memory.limit(size = 8000000)
  library(readxl)
  library(writexl)
  library(plyr)
  library(dplyr)
  library(data.table)
  library(zoo)
  library(shiny)
  library(shinydashboard)
  library(shinydashboardPlus)
  library(shinyWidgets)
  library(htmlwidgets)
  library(lubridate)
  library(tcltk)
  library(tidyverse)
  library(plotly)
  library(knitr)
  library(kableExtra)
  library(leaflet)
  library(grid)
  library(gridExtra)
  library(eeptools)
  library(ggQC)
  library(zipcodeR)
  library(utils)
  library(scales)
  library(chron)
  library(bupaR)
  library(shiny)
  library(DT)
  library(DiagrammeR)
  library(shinyalert)
  library(edeaR)
  library(processmapR)
  library(processmonitR)
  library(processanimateR)
  library(tidyr)
  library(lubridate)
  library(RColorBrewer)
  library(DiagrammeR)
  library(ggplot2)
  library(leaflet)
  library(readr)
  library(highcharter)
  library(ggforce) # for 'geom_arc_bar'
  library(packcircles) # for packed circle graph
  library(viridis)
  library(ggiraph)
  library(treemapify)
  library(treemap)
  library(broom)
  library(extrafont)
  library(tis) # for US holidays
  library(vroom)
  library(sjmisc)
  library(tools)
  library(here)
  library(shinyBS)
  library(shinyscreenshot)
  library(fasttime)
  library(shinycssloaders)
  library(feather)
  # library(zipcodeR)
  library(formattable)
  library(shinyjs)
  library(janitor)
  library(patchwork)
  library(flexdashboard)
  # library(tidyverse)
  # library(viridis)
  # library(hrbrthemes)
  # library(plotly)
  # install.packages("bsts")
  library(bsts)
  library(reactable)
  # install.packages("reactablefmtr")
  library(reactablefmtr)
  library(svDialogs)
  library(openxlsx)
  library(flextable)
  library(officedown)
  library(officer)
  library(magrittr)
  library(webshot) 
  library(png)
  library(ggh4x)
  library(RODBC)
  library(DBI)
  library(odbc)
})

```


```{r Graph asthetics, echo = FALSE, warning = FALSE, message = FALSE}
### Color Functions for Graphs ============================================================

# Mount Sinai corporate colors "USE THIS TO ADD COLORS"
MountSinai_colors <- c(
  `dark purple`  = "#212070",
  `dark pink`    = "#d80b8c",
  `dark blue`    = "#00aeef",
  `dark grey`    = "#7f7f7f",
  `yellow`       = "#ffc000",
  `purple`       = "#7030a0",
  `med purple`   = "#5753d0",
  `med pink`     = "#f75dbe",
  `med blue`     = "#5cd3ff",
  `med grey`     = "#a5a7a5",
  `light purple` = "#c7c6ef",
  `light pink`   = "#fcc9e9",
  `light blue`   = "#c9f0ff",
  `light grey`   = "#dddedd"
  )

# Function to extract Mount Sinai colors as hex codes
# Use Character names of MountSinai_colors

MountSinai_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (MountSinai_colors)
  
  MountSinai_colors[cols]
}

# Color Function that can be used to call all colors is "MountSinai_cols()"
# Use in ggplot 

  #MountSinai_cols()       # will provide all colors and their hex codes in a table 
  #MountSinai_cols("pink") # will provide color name and the hex code for the pink color

# Create palettes 
MountSinai_palettes <- list(
  `all`   = MountSinai_cols("dark purple","dark pink","dark blue","dark grey",
                            "med purple","med pink","med blue","med grey", 
                            "light purple","light pink","light blue","light grey"),
  
  `main`  = MountSinai_cols("dark purple","dark pink","dark blue","dark grey"),
  
  `purple`  = MountSinai_cols("dark purple","med purple","light purple"),
  
  `pink`  = MountSinai_cols("dark pink","med pink","light pink"),
  
  `blue`  = MountSinai_cols("dark blue", "med blue", "light blue"),
  
  `grey`  = MountSinai_cols("dark grey", "med grey", "light grey"),
  
  `purpleGrey` = MountSinai_cols("dark purple", "dark grey"),
  
  `pinkBlue` = MountSinai_cols("dark pink", "dark blue")
  
)

# MountSinai_palettes
# Return function to interpolate a Mount Sinai color palette
# default value is the main palette, reverse = True will change the order

MountSinai_pal <- function(palette = "all", reverse = FALSE, ...) {
  pal <- MountSinai_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}



# Scale Function for ggplot can be used instead of scale_color_manual
scale_color_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

# Scale Fill for ggplot insetead of scale_fill_manual 
scale_fill_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

# Use in ggplot 
  # scale_color_MountSinai("main")

```


```{r Global Functions, echo = FALSE, warning = FALSE, message = FALSE}

'%!in%' <- function(x,y)!('%in%'(x,y)) # Does not include
not_all_na <- function(x) all(!is.na(x)) # Exclude columns with All NAs

```


```{r Import Data, echo = FALSE, warning = FALSE, message = FALSE}

# scheduling_data_raw <- as.data.frame(readRDS("historical_data.rds")) %>%
#   mutate(Campus = ifelse(Campus == "MSDD", "MSDMG", Campus)) %>%
#   filter(!is.na(Campus)) %>%
#   filter(Appt.Status %in% c("Arrived","No Show","Canceled"))

scheduling_data_raw <- as.data.frame(readRDS("/nfs/data/Applications/Ambulatory/Data_Updated/historical_data.rds")) %>%
  mutate(Campus = ifelse(Campus == "MSDD", "MSDMG", Campus)) %>%
  filter(!is.na(Campus)) %>%
  filter(Appt.Status %in% c("Arrived","No Show","Canceled"))
  

sites <- c("NETWORK","MSM","MSH-MSDFP","ONCOLOGY","MSW","MSBI","MSUS","MSH- AMBULATORY CARE","MSDMG")

start_date <- "2022-01-01"
end_date <- Sys.Date()-1

holidays <- paste(names(holidaysBetween(as.Date(start_date), as.Date(end_date), goodFriday = F, board = T, inaug = F, businessOnly = F)),collapse=", ")

scheduling_data_raw <- scheduling_data_raw %>%
  filter(Appt.DateYear >= as.Date(start_date) & Appt.DateYear <= end_date) %>%
  mutate(holiday = isHoliday(Appt.DateYear, goodFriday = F, board = F, inaug = F, businessOnly = T)) 

scheduling_data_raw <- scheduling_data_raw %>%
  mutate(Appt.Cancel.DateYear = 
           as.Date(as.POSIXct(Appt.Cancel.DTTM,format="%Y-%m-%d %H:%M:%S",tz=Sys.timezone(),origin = "1970-01-01"), format="%Y-%m-%d")) %>%
  mutate(Appt.Status = case_when(Appt.Status == "Canceled" & Appt.DateYear == as.Date(Appt.Cancel.DateYear) ~ "Same-Day Canceled",
                                 TRUE ~ Appt.Status))


# Manual Grouping of Department Specialty --------------------------------------
scheduling_data_raw <- scheduling_data_raw %>%
  mutate(Campus.Specialty.Group.Group = case_when(str_detect(Campus.Specialty, "Peds") ~ "Peds Subspecialties",
                                            Campus.Specialty %in% c("OB/Gyn","Obstetrics","Gynecology") ~ "OB/Gyn",
                                            Campus.Specialty %in% c("Family Medicine","Internal Medicine") ~ "Primary Care",
                                            Campus.Specialty %in% c("Geriatrics","Gerontology") ~ "Geriatrics",
                                            TRUE ~ Campus.Specialty))

```


```{r Global Variables, echo = FALSE, warning = FALSE, message = FALSE}
report_run_date <- Sys.Date()
current_year <- year(report_run_date)
```


```{r Volume Variance Calculation, echo = FALSE, warning = FALSE, message = FALSE}

# By MSHS -------------------------------------------------------------------
## Volume and Variance YTD --------------------------------------------------
arrived_calculation_ytd_site <- scheduling_data_raw %>%
  filter(Campus %in% sites) %>%
  filter(holiday == FALSE) %>%
  filter(Appt.Status == "Arrived") %>%
  filter(Appt.Day %!in% c("Sat","Sun")) %>%
  filter(Appt.Year == current_year) %>%
  group_by(Appt.Year, Campus, Appt.DateYear, Appt.Day) %>%
  summarise(total = n()) %>%
  group_by(Appt.Year, Campus, Appt.Day) %>%
  mutate(total_day = sum(total),
         avg_vol_day = round(mean(total))) %>% 
  ungroup() %>%
  group_by(Appt.Year, Campus) %>%
  mutate(avg_vol_all = round(mean(total))) %>%
  group_by(Appt.Year, Campus, Appt.Day, total_day, avg_vol_all, avg_vol_day) %>%
  summarise(unique = n()) %>%
  mutate(daily_var = round((avg_vol_day-(mean(avg_vol_all)))/(mean(avg_vol_all)),2)) %>%
  dplyr::select(-unique)

arrived_calculation_ytd_mshs <- scheduling_data_raw %>%
  filter(Campus %in% sites) %>%
  filter(holiday == FALSE) %>%
  filter(Appt.Status == "Arrived") %>%
  filter(Appt.Day %!in% c("Sat","Sun")) %>%
  filter(Appt.Year == current_year) %>%
  group_by(Appt.Year, Appt.DateYear, Appt.Day) %>%
  summarise(total = n()) %>%
  group_by(Appt.Year, Appt.Day) %>%
  mutate(total_day = sum(total),
         avg_vol_day = round(mean(total))) %>% 
  ungroup() %>%
  group_by(Appt.Year) %>%
  mutate(avg_vol_all = round(mean(total))) %>%
  group_by(Appt.Year, Appt.Day, total_day, avg_vol_all, avg_vol_day) %>%
  summarise(unique = n()) %>%
  mutate(daily_var = round((avg_vol_day-(mean(avg_vol_all)))/(mean(avg_vol_all)),2)) %>%
  dplyr::select(-unique) %>%
  mutate(Campus = "MSHS Total")

arrived_calculation_ytd_merged <- bind_rows(arrived_calculation_ytd_site, arrived_calculation_ytd_mshs)


## Volume and Variance Trend --------------------------------------------------
arrived_calculation_ytd_specialty <- scheduling_data_raw %>%
  filter(Campus %in% sites) %>%
  filter(holiday == FALSE) %>%
  filter(Appt.Status == "Arrived") %>%
  filter(Appt.Day %!in% c("Sat","Sun")) %>%
  filter(Appt.Year == current_year) %>%
  group_by(Appt.Year, Campus, Campus.Specialty.Group, Appt.DateYear, Appt.Day) %>%
  summarise(total = n()) %>%
  group_by(Appt.Year, Campus, Campus.Specialty.Group, Appt.Day) %>%
  mutate(total_day = sum(total),
         avg_vol_day = round(mean(total))) %>% 
  ungroup() %>%
  group_by(Appt.Year, Campus, Campus.Specialty.Group) %>%
  mutate(avg_vol_all = round(mean(total))) %>%
  group_by(Appt.Year, Campus, Campus.Specialty.Group, Appt.Day, total_day, avg_vol_all, avg_vol_day) %>%
  summarise(unique = n()) %>%
  mutate(daily_var = round((avg_vol_day-(mean(avg_vol_all)))/(mean(avg_vol_all)),2)) %>%
  dplyr::select(-unique)


# By Site -------------------------------------------------------------------
arrived_calculation_trend_site <- scheduling_data_raw %>%
  filter(Campus %in% sites) %>%
  filter(holiday == FALSE) %>%
  filter(Appt.Status == "Arrived") %>%
  filter(Appt.Day %!in% c("Sat","Sun")) %>%
  group_by(Campus, Appt.MonthYear, Appt.DateYear, Appt.Day) %>%
  summarise(total = n()) %>%
  group_by(Campus, Appt.MonthYear, Appt.Day) %>%
  mutate(avg_vol_day = mean(total)) %>% 
  ungroup() %>%
  group_by(Campus, Appt.MonthYear) %>%
  mutate(avg_vol_all = mean(total)) %>%
  group_by(Campus, Appt.MonthYear, Appt.Day, avg_vol_all, avg_vol_day) %>%
  summarise(total_vol = sum(total)) %>%
  mutate(daily_var = round((avg_vol_day-(mean(avg_vol_all)))/(mean(avg_vol_all)),2))


# By site and Specialty -----------------------------------------------------------------
arrived_calculation_trend_specialty <- scheduling_data_raw %>%
  filter(Campus %in% sites) %>%
  filter(holiday == FALSE) %>%
  filter(Appt.Status == "Arrived") %>%
  filter(Appt.Day %!in% c("Sat","Sun")) %>%
  group_by(Campus, Campus.Specialty.Group, Appt.MonthYear, Appt.DateYear, Appt.Day) %>%
  summarise(total = n()) %>%
  group_by(Campus, Campus.Specialty.Group, Appt.MonthYear, Appt.Day) %>%
  mutate(avg_vol_day = mean(total)) %>% 
  ungroup() %>%
  group_by(Campus, Campus.Specialty.Group, Appt.MonthYear) %>%
  mutate(avg_vol_all = mean(total)) %>%
  group_by(Campus, Campus.Specialty.Group, Appt.MonthYear, Appt.Day, avg_vol_all, avg_vol_day) %>%
  summarise(total_vol = sum(total)) %>%
  mutate(daily_var = round((avg_vol_day-(mean(avg_vol_all)))/(mean(avg_vol_all)),2))

```


```{r No Show Calculation, echo = FALSE, warning = FALSE, message = FALSE}

# By Specialty -------------------------------------------------------------------
no_show_specialty <- scheduling_data_raw %>%
  filter(Campus %in% sites) %>%
  filter(Appt.Status %in% c("Arrived", "No Show", "Same-Day Canceled")) %>%
  group_by(Campus, Campus.Specialty.Group, Appt.Year, Appt.MonthYear, New.PT2, Appt.Status) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = Appt.Status,
              values_from = total,
              values_fill = 0)

# Add Missing ApptStatusFinal
  nms <- c("Campus", "Campus.Specialty.Group", "Appt.Year", "Appt.MonthYear", "New.PT2",
          "Arrived", "No Show", "Same-Day Canceled")   # Vector of columns you want in this data.frame
  
  Missing <- setdiff(nms, names(no_show_specialty))  # Find names of missing columns
  no_show_specialty[Missing] <- 0                    # Add them, filled with '0's
  no_show_specialty <- no_show_specialty[nms]     
  
  no_show_specialty <- no_show_specialty %>%
    mutate(Total = sum(across(where(is.numeric)))) 
  
  
  
# By Department -------------------------------------------------------------------
no_show_dept <- scheduling_data_raw %>%
    filter(Campus %in% sites) %>%
  filter(Appt.Status %in% c("Arrived", "No Show", "Same-Day Canceled")) %>%
  group_by(Campus, Campus.Specialty.Group, Department, Appt.Year, Appt.MonthYear, New.PT2, Appt.Status) %>%
  summarise(total = n()) %>%
  pivot_wider(names_from = Appt.Status,
              values_from = total,
              values_fill = 0)

# Add Missing ApptStatusFinal
  nms <- c("Campus", "Campus.Specialty.Group", "Department", "Appt.Year", "Appt.MonthYear", "New.PT2",
          "Arrived", "No Show", "Same-Day Canceled")   # Vector of columns you want in this data.frame
  
  Missing <- setdiff(nms, names(no_show_dept ))  # Find names of missing columns
  no_show_dept [Missing] <- 0                    # Add them, filled with '0's
  no_show_dept  <- no_show_dept [nms]     
  
  no_show_dept  <- no_show_dept  %>%
    mutate(Total = sum(across(where(is.numeric)))) 

```


```{r Sinai Logo, echo=FALSE, out.width = '15%'}
knitr::include_graphics("Mount_Sinai_Logo_H.png")
```


# Ambulatory Volume Variance
*Report run date: `r report_run_date`*<br/>
*Excludes Rad Onc and Radiology data*<br/>
*Excludes eIDX, MD Office data.*<br/>
______________________________________________________________________________________________________________________________
<br/>

## MSHS
### Variance by Day of Week {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSHS YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

day_order <- c('Mon','Tue','Wed','Thu','Fri')
site_order <- c("MSBI","MSDMG","MSH- AMBULATORY CARE","MSH-MSDFP","MSM","MSUS","MSW","NETWORK","ONCOLOGY","MSHS Total")

ytd_total_volume_mshs <- arrived_calculation_ytd_merged %>%
  arrange(match(Appt.Day, day_order)) %>%
  ungroup() %>%
  dplyr::select(Campus, Appt.Day, total_day) %>%
  mutate(Appt.Day = paste0(Appt.Day,"_total_day")) %>%
  pivot_wider(names_from = Appt.Day,
              values_from = total_day) %>%
  mutate(blank = "")
  
ytd_avg_volume_mshs <- arrived_calculation_ytd_merged %>%
  arrange(match(Appt.Day, day_order)) %>%
  ungroup() %>%
  dplyr::select(Campus, Appt.Day, avg_vol_day) %>%
  mutate(Appt.Day = paste0(Appt.Day,"_avg_day")) %>%
  pivot_wider(names_from = Appt.Day,
              values_from = avg_vol_day) %>%
  mutate(blank1 = "")

ytd_avg_var_mshs <- arrived_calculation_ytd_merged %>%
  arrange(match(Appt.Day, day_order)) %>%
  ungroup() %>%
  dplyr::select(Campus, Appt.Day, daily_var) %>%
  mutate(Appt.Day = paste0(Appt.Day,"_var")) %>%
  pivot_wider(names_from = Appt.Day,
              values_from = daily_var)

ytd_mshs_merged <- merge(ytd_total_volume_mshs, ytd_avg_volume_mshs)
ytd_mshs_merged <- merge(ytd_mshs_merged, ytd_avg_var_mshs)
ytd_mshs_merged <- ytd_mshs_merged %>%
  arrange(match(Campus, site_order)) 

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_mshs_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_mshs_merged %>% filter(Campus %in% site_order),
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    rowStyle = function(index) {
            if (index %in% c(10)) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus = colDef(
        name = "Site",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left"
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

#### Trend
```{r MSHS Volume Trend Output, echo = FALSE, warning = FALSE, message = FALSE}

volume_trend_mshs <- arrived_calculation_trend_site %>%
  arrange(match(Appt.Day, day_order)) %>%
  ungroup() %>%
  mutate(daily_var = daily_var*100) %>%
  dplyr::select(Appt.MonthYear, Campus, Appt.Day, avg_vol_all, daily_var) %>%
  pivot_wider(names_from = Appt.Day,
              values_from = daily_var) %>%
  arrange(Appt.MonthYear)


map(unique(volume_trend_mshs$Campus), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "% Variance from Daily Avg Volume"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 0, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (volume_trend_mshs %>% filter(Campus == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Mon",
                data   = (volume_trend_mshs %>% filter(Campus == x))$Mon,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "Tue",
                data   = (volume_trend_mshs %>% filter(Campus == x))$Tue,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "Wed",
                data   = (volume_trend_mshs %>% filter(Campus == x))$Wed,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#00aeef',
                lineWidth=3,
                lineColor='#00aeef'
                ) %>%
  hc_add_series(name   = "Thu",
                data   = (volume_trend_mshs %>% filter(Campus == x))$Thu,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_add_series(name   = "Fri",
                data   = (volume_trend_mshs %>% filter(Campus == x))$Fri,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#ffc000',
                lineWidth=3,
                lineColor='#ffc000'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = x, " - Volume Variance by Day of Week"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = paste0("Avg Volume by DOW Compared to Daily Avg Weekday Volume",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


### No Shows {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSHS No Show Output, echo = FALSE, warning = FALSE, message = FALSE}

no_show_ytd_mshs <- no_show_specialty %>%
  filter(Appt.Year == current_year) %>%
  group_by(Campus, Campus.Specialty.Group, New.PT2) %>%
  summarise(Arrived = sum(Arrived),
            `NoShow` = sum(`No Show`),
            `SameDayCanceled` = sum(`Same-Day Canceled`),
            Total = sum(Total)) %>%
  mutate(noShow_rate = round((`NoShow` + `SameDayCanceled`)/ Total,2)) %>%
  pivot_wider(names_from = New.PT2,
              values_from = 4:8,
              values_fill = 0) %>%
  mutate(Total = (Total_Established + Total_New),
         noShow_rate = round((`NoShow_Established` + `SameDayCanceled_Established` + `NoShow_New` + `SameDayCanceled_New`)/Total,2),
         new_perc = round(Total_New/Total,2))


# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('mshs_ytd_noshow-download-table', 'Avg No Show Rate')"
    ),

reactable(
  no_show_ytd_mshs,
  elementId = "mshs_ytd_noshow-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = "Campus",

  columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Visit Volume"), 
             columns = c("Total", "new_perc"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " No Show Rate"), 
             columns = c("noShow_rate", "noShow_rate_Established", "noShow_rate_New"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),

  columns = list(

    Campus = colDef(
      # footer = "Total",
      name = "Site",
      maxWidth = 220),

    Campus.Specialty.Group = colDef(
      name = "Specialty",
      maxWidth = 250),

    `noShow_rate_Established` = colDef(
      name = "No Show Rate - Established",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalTotal_Established = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalTotal_Established += row['Total_Established']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established) / totalTotal_Established
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate_New` = colDef(
      name = "No Show Rate - New",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal_New = 0
        rows.forEach(function(row) {
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal_New += row['Total_New']
        })
        return (totalNoShow_New + totalSameDayCanceled_New) / totalTotal_New
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate` = colDef(
      name = "No Show Rate - All",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal += row['Total']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established + totalNoShow_New + totalSameDayCanceled_New) / totalTotal
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    Total = colDef(
      name = "Total Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    new_perc = colDef(
      name = "% New Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal_New += row['Total_New']
          totalTotal += row['Total']
        })
        return (totalTotal_New) / totalTotal
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    

    Arrived_Established = colDef(show =F),
    Arrived_New = colDef(show =F),
    NoShow_Established = colDef(show =F),
    NoShow_New = colDef(show =F),
    `SameDayCanceled_Established` = colDef(show =F),
    `SameDayCanceled_New` = colDef(show =F),
    `SameDayRescheduled_Established` = colDef(show =F),
    `SameDayRescheduled_New` = colDef(show =F),
    `SameDayBump_Established` = colDef(show =F),
    `SameDayBump_New` = colDef(show =F),
    `Total_Established` = colDef(show =F),
    `Total_New` = colDef(show =F),
    `Total` = colDef(show =F)

  ) # Close Columns

  ) # Close Reactable

 )
)

```


#### Trend
```{r MSHS No Show Trend, echo = FALSE, warning = FALSE, message = FALSE}

no_show_trend_mshs <- no_show_specialty %>%
  group_by(Campus, Appt.MonthYear, New.PT2) %>%
  summarise(Arrived = sum(Arrived),
            `NoShow` = sum(`No Show`),
            `SameDayCanceled` = sum(`Same-Day Canceled`),
            Total = sum(Total)) %>%
  mutate(noShow_rate = round((`NoShow` + `SameDayCanceled`)/ Total,2)*100) %>%
  pivot_wider(names_from = New.PT2,
              values_from = 4:8,
              values_fill = 0) %>%
  mutate(Total = (Total_Established + Total_New),
         noShow_rate = round((`NoShow_Established` + `SameDayCanceled_Established` + `NoShow_New` + `SameDayCanceled_New`)/Total,2)*100,
         new_perc = round(Total_New/Total,2)*100)



map(unique(no_show_trend_mshs$Campus), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "No Show Rate"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 20, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (no_show_trend_mshs %>% filter(Campus == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Established",
                data   = (no_show_trend_mshs %>% filter(Campus == x))$noShow_rate_Established,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "New",
                data   = (no_show_trend_mshs %>% filter(Campus == x))$noShow_rate_New,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "All",
                data   = (no_show_trend_mshs %>% filter(Campus == x))$noShow_rate,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0(x, " - Avg No Show Rate"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Target:",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


```{r Site YTD Volume Function, echo = FALSE, warning = FALSE, message = FALSE}

day_order <- c('Mon','Tue','Wed','Thu','Fri')
site_order <- c("MSBI","MSDMG","MSH- AMBULATORY CARE","MSH-MSDFP","MSM","MSUS","MSW","NETWORK","ONCOLOGY","MSHS Total")

ytd_total_volume_site_function <- function(site){
  
  # site <- "MSBI"
  ytd_site <- arrived_calculation_ytd_site %>%
    filter(Campus == site)
  
  ytd_total_volume_site <- ytd_site %>%
    arrange(match(Appt.Day, day_order)) %>%
    ungroup() %>%
    dplyr::select(Campus, Appt.Day, total_day) %>%
    mutate(Appt.Day = paste0(Appt.Day,"_total_day")) %>%
    pivot_wider(names_from = Appt.Day,
                values_from = total_day) %>%
    mutate(blank = "")
  
  ytd_avg_volume_site <- ytd_site %>%
    arrange(match(Appt.Day, day_order)) %>%
    ungroup() %>%
    dplyr::select(Campus, Appt.Day, avg_vol_day) %>%
    mutate(Appt.Day = paste0(Appt.Day,"_avg_day")) %>%
    pivot_wider(names_from = Appt.Day,
                values_from = avg_vol_day) %>%
    mutate(blank1 = "")

  ytd_avg_var_site <- ytd_site %>%
    arrange(match(Appt.Day, day_order)) %>%
    ungroup() %>%
    dplyr::select(Campus, Appt.Day, daily_var) %>%
    mutate(Appt.Day = paste0(Appt.Day,"_var")) %>%
    pivot_wider(names_from = Appt.Day,
                values_from = daily_var)

  ytd_site_merged <- merge(ytd_total_volume_site, ytd_avg_volume_site)
  ytd_site_merged <- merge(ytd_site_merged, ytd_avg_var_site)
  
}


ytd_total_volume_specialty_function <- function(site){
  
  # site <- "MSBI"
  ytd_specialty <- arrived_calculation_ytd_specialty %>%
    filter(Campus == site)
  
  ytd_total_volume_specialty <- ytd_specialty %>%
    arrange(match(Appt.Day, day_order)) %>%
    ungroup() %>%
    dplyr::select(Campus.Specialty.Group, Appt.Day, total_day) %>%
    mutate(Appt.Day = paste0(Appt.Day,"_total_day")) %>%
    pivot_wider(names_from = Appt.Day,
                values_from = total_day) %>%
    mutate(blank = "")
  
  ytd_avg_volume_specialty <- ytd_specialty %>%
    arrange(match(Appt.Day, day_order)) %>%
    ungroup() %>%
    dplyr::select(Campus.Specialty.Group, Appt.Day, avg_vol_day) %>%
    mutate(Appt.Day = paste0(Appt.Day,"_avg_day")) %>%
    pivot_wider(names_from = Appt.Day,
                values_from = avg_vol_day) %>%
    mutate(blank1 = "")

  ytd_avg_var_specialty <- ytd_specialty %>%
    arrange(match(Appt.Day, day_order)) %>%
    ungroup() %>%
    dplyr::select(Campus.Specialty.Group, Appt.Day, daily_var) %>%
    mutate(Appt.Day = paste0(Appt.Day,"_var")) %>%
    pivot_wider(names_from = Appt.Day,
                values_from = daily_var)

  ytd_specialty_merged <- merge(ytd_total_volume_specialty, ytd_avg_volume_specialty)
  ytd_specialty_merged <- merge(ytd_specialty_merged, ytd_avg_var_specialty)
  
}


```


```{r Site Volume Trend Function, echo = FALSE, warning = FALSE, message = FALSE}

day_order <- c('Mon','Tue','Wed','Thu','Fri')
site_order <- c("MSBI","MSDMG","MSH- AMBULATORY CARE","MSH-MSDFP","MSM","MSUS","MSW","NETWORK","ONCOLOGY","MSHS Total")

volume_trend_specialty_function <- function(site){
  
  # site <- "MSBI"
  volume_trend_specialty <- arrived_calculation_trend_specialty %>%
    filter(Campus == site) %>%
    arrange(match(Appt.Day, day_order)) %>%
    ungroup() %>%
    mutate(daily_var = daily_var*100) %>%
    dplyr::select(Appt.MonthYear, Campus.Specialty.Group, Appt.Day, avg_vol_all, daily_var) %>%
    pivot_wider(names_from = Appt.Day,
                values_from = daily_var) %>%
    arrange(Appt.MonthYear)
  
}

```


```{r Site YTD No Show Function, echo = FALSE, warning = FALSE, message = FALSE}

no_show_ytd_site_function <- function(site){
  
  # site <- "MSUS"
  no_show_ytd_dept <- no_show_dept %>%
    filter(Campus == site) %>%
    group_by(Campus, Campus.Specialty.Group, Department, New.PT2) %>%
    summarise(Arrived = sum(Arrived),
              `NoShow` = sum(`No Show`),
              `SameDayCanceled` = sum(`Same-Day Canceled`),
              Total = sum(Total)) %>%
    mutate(noShow_rate = round((`NoShow` + `SameDayCanceled`)/ Total,2)) %>%
    pivot_wider(names_from = New.PT2,
                values_from = 5:9,
                values_fill = 0) %>%
    mutate(Total = (Total_Established + Total_New),
           noShow_rate = round((`NoShow_Established` + `SameDayCanceled_Established` + `NoShow_New` + `SameDayCanceled_New`)/Total,2),
           new_perc = round(Total_New/Total,2))
  
}
```


```{r Site No Show Trend Function, echo = FALSE, warning = FALSE, message = FALSE}

no_show_trend_site_function <- function(site){
  
  no_show_trend_site <- no_show_dept %>%
    filter(Campus == site) %>%
    group_by(Campus, Campus.Specialty.Group, Appt.MonthYear, New.PT2) %>%
    summarise(Arrived = sum(Arrived),
              `NoShow` = sum(`No Show`),
              `SameDayCanceled` = sum(`Same-Day Canceled`),
              Total = sum(Total)) %>%
    mutate(noShow_rate = round((`NoShow` + `SameDayCanceled`)/ Total,2)*100) %>%
    pivot_wider(names_from = New.PT2,
                values_from = 5:9,
                values_fill = 0) %>%
    mutate(Total = (Total_Established + Total_New),
           noShow_rate = round((`NoShow_Established` + `SameDayCanceled_Established` + `NoShow_New` + `SameDayCanceled_New`)/Total,2)*100,
           new_perc = round(Total_New/Total,2)*100) %>%
    arrange(Appt.MonthYear)
}
```


## MSBI
### Variance by Day of Week {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSBI YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_msbi_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_site_function("MSBI"),
    elementId = "ytd_msbi_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    rowStyle = function(index) {
            if (index %in% c(10)) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus = colDef(
        name = "Site",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left"
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

```{r MSBI Specialty YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_msbi_specialty_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_specialty_function("MSBI"),
    elementId = "ytd_msbi_specialty_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    # rowStyle = function(index) {
    #         if (index %in% c(10)) {
    #           list(`border-top` = "2px solid rgb(184,184,184)",
    #                fontWeight = "Bold")
    #         }
    #       },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus.Specialty.Group = colDef(
        name = "Specialty",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left",
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

#### Trend
```{r MSBI Volume Trend Output, echo = FALSE, warning = FALSE, message = FALSE}

volume_trend_specialty_output <- volume_trend_specialty_function("MSBI")

map(unique(volume_trend_specialty_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "% Variance from Daily Avg Volume"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 0, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Mon",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Mon,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "Tue",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Tue,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "Wed",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Wed,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#00aeef',
                lineWidth=3,
                lineColor='#00aeef'
                ) %>%
  hc_add_series(name   = "Thu",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Thu,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_add_series(name   = "Fri",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Fri,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#ffc000',
                lineWidth=3,
                lineColor='#ffc000'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSBI ", x, " - Volume Variance by Day of Week"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Avg Volume by DOW Compared to Daily Avg Weekday Volume",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


### No Shows {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSBI No Show Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('msbi_ytd_noshow-download-table', 'Avg No Show Rate')"
    ),

reactable(
  no_show_ytd_site_function("MSBI"),
  elementId = "msbi_ytd_noshow-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = "Campus.Specialty.Group",

  columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Visit Volume"), 
             columns = c("Total", "new_perc"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " No Show Rate"), 
             columns = c("noShow_rate", "noShow_rate_Established", "noShow_rate_New"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),

  columns = list(

    Campus.Specialty.Group = colDef(
      name = "Specialty",
      maxWidth = 250),
    
    Department = colDef(
      name = "Department",
      maxWidth = 300),
    

    `noShow_rate_Established` = colDef(
      name = "No Show Rate - Established",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalTotal_Established = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalTotal_Established += row['Total_Established']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established) / totalTotal_Established || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate_New` = colDef(
      name = "No Show Rate - New",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal_New = 0
        rows.forEach(function(row) {
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal_New += row['Total_New']
        })
        return (totalNoShow_New + totalSameDayCanceled_New) / totalTotal_New || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate` = colDef(
      name = "No Show Rate - All",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal += row['Total']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established + totalNoShow_New + totalSameDayCanceled_New) / totalTotal || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    Total = colDef(
      name = "Total Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    new_perc = colDef(
      name = "% New Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal_New += row['Total_New']
          totalTotal += row['Total']
        })
        return (totalTotal_New) / totalTotal
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    

    Arrived_Established = colDef(show =F),
    Arrived_New = colDef(show =F),
    NoShow_Established = colDef(show =F),
    NoShow_New = colDef(show =F),
    `SameDayCanceled_Established` = colDef(show =F),
    `SameDayCanceled_New` = colDef(show =F),
    `SameDayRescheduled_Established` = colDef(show =F),
    `SameDayRescheduled_New` = colDef(show =F),
    `SameDayBump_Established` = colDef(show =F),
    `SameDayBump_New` = colDef(show =F),
    `Total_Established` = colDef(show =F),
    `Total_New` = colDef(show =F),
    `Total` = colDef(show =F),
    Campus = colDef(show =F)

  ) # Close Columns

  ) # Close Reactable

 )
)

```


#### Trend
```{r MSBI No Show Trend, echo = FALSE, warning = FALSE, message = FALSE}

no_show_trend_site_output <- no_show_trend_site_function("MSBI")

map(unique(no_show_trend_site_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "No Show Rate"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 20, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Established",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_Established,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "New",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_New,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "All",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSBI ", x, " - Avg No Show Rate"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Target:",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```



## MSDMG
### Variance by Day of Week {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSDMG YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_msdmg_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_site_function("MSDMG"),
    elementId = "ytd_msdmg_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    rowStyle = function(index) {
            if (index %in% c(10)) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus = colDef(
        name = "Site",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left"
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

```{r MSDMG Specialty YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_msdmg_specialty_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_specialty_function("MSDMG"),
    elementId = "ytd_msdmg_specialty_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    # rowStyle = function(index) {
    #         if (index %in% c(10)) {
    #           list(`border-top` = "2px solid rgb(184,184,184)",
    #                fontWeight = "Bold")
    #         }
    #       },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus.Specialty.Group = colDef(
        name = "Specialty",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left",
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

#### Trend
```{r MSDMG Volume Trend Output, echo = FALSE, warning = FALSE, message = FALSE}

volume_trend_specialty_output <- volume_trend_specialty_function("MSDMG")

map(unique(volume_trend_specialty_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "% Variance from Daily Avg Volume"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 0, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Mon",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Mon,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "Tue",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Tue,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "Wed",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Wed,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#00aeef',
                lineWidth=3,
                lineColor='#00aeef'
                ) %>%
  hc_add_series(name   = "Thu",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Thu,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_add_series(name   = "Fri",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Fri,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#ffc000',
                lineWidth=3,
                lineColor='#ffc000'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSDMG ", x, " - Volume Variance by Day of Week"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Avg Volume by DOW Compared to Daily Avg Weekday Volume",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


### No Shows {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSDMG No Show Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('msdmg_ytd_noshow-download-table', 'Avg No Show Rate')"
    ),

reactable(
  no_show_ytd_site_function("MSDMG"),
  elementId = "msdmg_ytd_noshow-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = "Campus.Specialty.Group",

  columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Visit Volume"), 
             columns = c("Total", "new_perc"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " No Show Rate"), 
             columns = c("noShow_rate", "noShow_rate_Established", "noShow_rate_New"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),

  columns = list(

    Campus.Specialty.Group = colDef(
      name = "Specialty",
      maxWidth = 250),
    
    Department = colDef(
      name = "Department",
      maxWidth = 300),
    

    `noShow_rate_Established` = colDef(
      name = "No Show Rate - Established",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalTotal_Established = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalTotal_Established += row['Total_Established']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established) / totalTotal_Established || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate_New` = colDef(
      name = "No Show Rate - New",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal_New = 0
        rows.forEach(function(row) {
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal_New += row['Total_New']
        })
        return (totalNoShow_New + totalSameDayCanceled_New) / totalTotal_New || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate` = colDef(
      name = "No Show Rate - All",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal += row['Total']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established + totalNoShow_New + totalSameDayCanceled_New) / totalTotal || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    Total = colDef(
      name = "Total Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    new_perc = colDef(
      name = "% New Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal_New += row['Total_New']
          totalTotal += row['Total']
        })
        return (totalTotal_New) / totalTotal
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    

    Arrived_Established = colDef(show =F),
    Arrived_New = colDef(show =F),
    NoShow_Established = colDef(show =F),
    NoShow_New = colDef(show =F),
    `SameDayCanceled_Established` = colDef(show =F),
    `SameDayCanceled_New` = colDef(show =F),
    `SameDayRescheduled_Established` = colDef(show =F),
    `SameDayRescheduled_New` = colDef(show =F),
    `SameDayBump_Established` = colDef(show =F),
    `SameDayBump_New` = colDef(show =F),
    `Total_Established` = colDef(show =F),
    `Total_New` = colDef(show =F),
    `Total` = colDef(show =F),
    Campus = colDef(show =F)

  ) # Close Columns

  ) # Close Reactable

 )
)

```


#### Trend
```{r MSDMG No Show Trend, echo = FALSE, warning = FALSE, message = FALSE}

no_show_trend_site_output <- no_show_trend_site_function("MSDMG")

map(unique(no_show_trend_site_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "No Show Rate"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 20, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Established",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_Established,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "New",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_New,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "All",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSDMG ", x, " - Avg No Show Rate"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Target:",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


## MSH- AMBULATORY CARE
### Variance by Day of Week {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSH- AMBULATORY CARE YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_amb_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_site_function("MSH- AMBULATORY CARE"),
    elementId = "ytd_amb_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    rowStyle = function(index) {
            if (index %in% c(10)) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus = colDef(
        name = "Site",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left"
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

```{r MSH- AMBULATORY CARE Specialty YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_amb_specialty_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_specialty_function("MSH- AMBULATORY CARE"),
    elementId = "ytd_amb_specialty_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    # rowStyle = function(index) {
    #         if (index %in% c(10)) {
    #           list(`border-top` = "2px solid rgb(184,184,184)",
    #                fontWeight = "Bold")
    #         }
    #       },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus.Specialty.Group = colDef(
        name = "Specialty",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left",
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

#### Trend
```{r MSH- AMBULATORY CARE Volume Trend Output, echo = FALSE, warning = FALSE, message = FALSE}

volume_trend_specialty_output <- volume_trend_specialty_function("MSH- AMBULATORY CARE")

map(unique(volume_trend_specialty_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "% Variance from Daily Avg Volume"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 0, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Mon",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Mon,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "Tue",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Tue,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "Wed",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Wed,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#00aeef',
                lineWidth=3,
                lineColor='#00aeef'
                ) %>%
  hc_add_series(name   = "Thu",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Thu,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_add_series(name   = "Fri",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Fri,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#ffc000',
                lineWidth=3,
                lineColor='#ffc000'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSH- AMBULATORY CARE ", x, " - Volume Variance by Day of Week"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Avg Volume by DOW Compared to Daily Avg Weekday Volume",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


### No Shows {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSH- AMBULATORY CARE No Show Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('amb_ytd_noshow-download-table', 'Avg No Show Rate')"
    ),

reactable(
  no_show_ytd_site_function("MSH- AMBULATORY CARE"),
  elementId = "amb_ytd_noshow-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = "Campus.Specialty.Group",

  columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Visit Volume"), 
             columns = c("Total", "new_perc"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " No Show Rate"), 
             columns = c("noShow_rate", "noShow_rate_Established", "noShow_rate_New"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),

  columns = list(

    Campus.Specialty.Group = colDef(
      name = "Specialty",
      maxWidth = 250),
    
    Department = colDef(
      name = "Department",
      maxWidth = 300),
    

    `noShow_rate_Established` = colDef(
      name = "No Show Rate - Established",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalTotal_Established = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalTotal_Established += row['Total_Established']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established) / totalTotal_Established || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate_New` = colDef(
      name = "No Show Rate - New",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal_New = 0
        rows.forEach(function(row) {
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal_New += row['Total_New']
        })
        return (totalNoShow_New + totalSameDayCanceled_New) / totalTotal_New || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate` = colDef(
      name = "No Show Rate - All",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal += row['Total']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established + totalNoShow_New + totalSameDayCanceled_New) / totalTotal || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    Total = colDef(
      name = "Total Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    new_perc = colDef(
      name = "% New Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal_New += row['Total_New']
          totalTotal += row['Total']
        })
        return (totalTotal_New) / totalTotal
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    

    Arrived_Established = colDef(show =F),
    Arrived_New = colDef(show =F),
    NoShow_Established = colDef(show =F),
    NoShow_New = colDef(show =F),
    `SameDayCanceled_Established` = colDef(show =F),
    `SameDayCanceled_New` = colDef(show =F),
    `SameDayRescheduled_Established` = colDef(show =F),
    `SameDayRescheduled_New` = colDef(show =F),
    `SameDayBump_Established` = colDef(show =F),
    `SameDayBump_New` = colDef(show =F),
    `Total_Established` = colDef(show =F),
    `Total_New` = colDef(show =F),
    `Total` = colDef(show =F),
    Campus = colDef(show =F)

  ) # Close Columns

  ) # Close Reactable

 )
)

```


#### Trend
```{r MSH- AMBULATORY CARE No Show Trend, echo = FALSE, warning = FALSE, message = FALSE}

no_show_trend_site_output <- no_show_trend_site_function("MSH- AMBULATORY CARE")

map(unique(no_show_trend_site_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "No Show Rate"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 20, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Established",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_Established,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "New",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_New,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "All",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSH- AMB CARE ", x, " - Avg No Show Rate"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Target:",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```



## MSH-MSDFP
### Variance by Day of Week {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSH-MSDFP YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_msdfp_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_site_function("MSH-MSDFP"),
    elementId = "ytd_msdfp_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    rowStyle = function(index) {
            if (index %in% c(10)) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus = colDef(
        name = "Site",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left"
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

```{r MSH-MSDFP Specialty YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_msdfp_specialty_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_specialty_function("MSH-MSDFP"),
    elementId = "ytd_msdfp_specialty_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    # rowStyle = function(index) {
    #         if (index %in% c(10)) {
    #           list(`border-top` = "2px solid rgb(184,184,184)",
    #                fontWeight = "Bold")
    #         }
    #       },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus.Specialty.Group = colDef(
        name = "Specialty",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left",
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

#### Trend
```{r MSH-MSDFP Volume Trend Output, echo = FALSE, warning = FALSE, message = FALSE}

volume_trend_specialty_output <- volume_trend_specialty_function("MSH-MSDFP")

map(unique(volume_trend_specialty_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "% Variance from Daily Avg Volume"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 0, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Mon",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Mon,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "Tue",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Tue,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "Wed",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Wed,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#00aeef',
                lineWidth=3,
                lineColor='#00aeef'
                ) %>%
  hc_add_series(name   = "Thu",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Thu,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_add_series(name   = "Fri",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Fri,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#ffc000',
                lineWidth=3,
                lineColor='#ffc000'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSH-MSDFP ", x, " - Volume Variance by Day of Week"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Avg Volume by DOW Compared to Daily Avg Weekday Volume",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


### No Shows {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSH-MSDFP No Show Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('msdfp_ytd_noshow-download-table', 'Avg No Show Rate')"
    ),

reactable(
  no_show_ytd_site_function("MSH-MSDFP"),
  elementId = "msdfp_ytd_noshow-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = "Campus.Specialty.Group",

  columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Visit Volume"), 
             columns = c("Total", "new_perc"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " No Show Rate"), 
             columns = c("noShow_rate", "noShow_rate_Established", "noShow_rate_New"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),

  columns = list(

    Campus.Specialty.Group = colDef(
      name = "Specialty",
      maxWidth = 250),
    
    Department = colDef(
      name = "Department",
      maxWidth = 300),
    

    `noShow_rate_Established` = colDef(
      name = "No Show Rate - Established",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalTotal_Established = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalTotal_Established += row['Total_Established']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established) / totalTotal_Established || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate_New` = colDef(
      name = "No Show Rate - New",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal_New = 0
        rows.forEach(function(row) {
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal_New += row['Total_New']
        })
        return (totalNoShow_New + totalSameDayCanceled_New) / totalTotal_New || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate` = colDef(
      name = "No Show Rate - All",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal += row['Total']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established + totalNoShow_New + totalSameDayCanceled_New) / totalTotal || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    Total = colDef(
      name = "Total Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    new_perc = colDef(
      name = "% New Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal_New += row['Total_New']
          totalTotal += row['Total']
        })
        return (totalTotal_New) / totalTotal
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    

    Arrived_Established = colDef(show =F),
    Arrived_New = colDef(show =F),
    NoShow_Established = colDef(show =F),
    NoShow_New = colDef(show =F),
    `SameDayCanceled_Established` = colDef(show =F),
    `SameDayCanceled_New` = colDef(show =F),
    `SameDayRescheduled_Established` = colDef(show =F),
    `SameDayRescheduled_New` = colDef(show =F),
    `SameDayBump_Established` = colDef(show =F),
    `SameDayBump_New` = colDef(show =F),
    `Total_Established` = colDef(show =F),
    `Total_New` = colDef(show =F),
    `Total` = colDef(show =F),
    Campus = colDef(show =F)

  ) # Close Columns

  ) # Close Reactable

 )
)

```


#### Trend
```{r MSH-MSDFP No Show Trend, echo = FALSE, warning = FALSE, message = FALSE}

no_show_trend_site_output <- no_show_trend_site_function("MSH-MSDFP")

map(unique(no_show_trend_site_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "No Show Rate"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 20, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Established",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_Established,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "New",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_New,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "All",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSH-MSDFP ", x, " - Avg No Show Rate"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Target:",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```



## MSM
### Variance by Day of Week {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSM YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_msm_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_site_function("MSM"),
    elementId = "ytd_msm_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    rowStyle = function(index) {
            if (index %in% c(10)) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus = colDef(
        name = "Site",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left"
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

```{r MSM Specialty YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_msm_specialty_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_specialty_function("MSM"),
    elementId = "ytd_msm_specialty_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    # rowStyle = function(index) {
    #         if (index %in% c(10)) {
    #           list(`border-top` = "2px solid rgb(184,184,184)",
    #                fontWeight = "Bold")
    #         }
    #       },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus.Specialty.Group = colDef(
        name = "Specialty",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left",
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

#### Trend
```{r MSM Volume Trend Output, echo = FALSE, warning = FALSE, message = FALSE}

volume_trend_specialty_output <- volume_trend_specialty_function("MSM")

map(unique(volume_trend_specialty_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "% Variance from Daily Avg Volume"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 0, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Mon",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Mon,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "Tue",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Tue,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "Wed",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Wed,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#00aeef',
                lineWidth=3,
                lineColor='#00aeef'
                ) %>%
  hc_add_series(name   = "Thu",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Thu,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_add_series(name   = "Fri",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Fri,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#ffc000',
                lineWidth=3,
                lineColor='#ffc000'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSM ", x, " - Volume Variance by Day of Week"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Avg Volume by DOW Compared to Daily Avg Weekday Volume",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


### No Shows {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSM No Show Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('msm_ytd_noshow-download-table', 'Avg No Show Rate')"
    ),

reactable(
  no_show_ytd_site_function("MSM"),
  elementId = "msm_ytd_noshow-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = "Campus.Specialty.Group",

  columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Visit Volume"), 
             columns = c("Total", "new_perc"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " No Show Rate"), 
             columns = c("noShow_rate", "noShow_rate_Established", "noShow_rate_New"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),

  columns = list(

    Campus.Specialty.Group = colDef(
      name = "Specialty",
      maxWidth = 250),
    
    Department = colDef(
      name = "Department",
      maxWidth = 300),
    

    `noShow_rate_Established` = colDef(
      name = "No Show Rate - Established",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalTotal_Established = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalTotal_Established += row['Total_Established']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established) / totalTotal_Established || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate_New` = colDef(
      name = "No Show Rate - New",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal_New = 0
        rows.forEach(function(row) {
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal_New += row['Total_New']
        })
        return (totalNoShow_New + totalSameDayCanceled_New) / totalTotal_New || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate` = colDef(
      name = "No Show Rate - All",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal += row['Total']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established + totalNoShow_New + totalSameDayCanceled_New) / totalTotal || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    Total = colDef(
      name = "Total Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    new_perc = colDef(
      name = "% New Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal_New += row['Total_New']
          totalTotal += row['Total']
        })
        return (totalTotal_New) / totalTotal
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    

    Arrived_Established = colDef(show =F),
    Arrived_New = colDef(show =F),
    NoShow_Established = colDef(show =F),
    NoShow_New = colDef(show =F),
    `SameDayCanceled_Established` = colDef(show =F),
    `SameDayCanceled_New` = colDef(show =F),
    `SameDayRescheduled_Established` = colDef(show =F),
    `SameDayRescheduled_New` = colDef(show =F),
    `SameDayBump_Established` = colDef(show =F),
    `SameDayBump_New` = colDef(show =F),
    `Total_Established` = colDef(show =F),
    `Total_New` = colDef(show =F),
    `Total` = colDef(show =F),
    Campus = colDef(show =F)

  ) # Close Columns

  ) # Close Reactable

 )
)

```


#### Trend
```{r MSM No Show Trend, echo = FALSE, warning = FALSE, message = FALSE}

no_show_trend_site_output <- no_show_trend_site_function("MSM")

map(unique(no_show_trend_site_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "No Show Rate"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 20, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Established",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_Established,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "New",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_New,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "All",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSM ", x, " - Avg No Show Rate"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Target:",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```



## MSUS
### Variance by Day of Week {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSUS YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_msus_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_site_function("MSUS"),
    elementId = "ytd_msus_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    rowStyle = function(index) {
            if (index %in% c(10)) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus = colDef(
        name = "Site",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left"
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

```{r MSUS Specialty YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_msus_specialty_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_specialty_function("MSUS"),
    elementId = "ytd_msus_specialty_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    # rowStyle = function(index) {
    #         if (index %in% c(10)) {
    #           list(`border-top` = "2px solid rgb(184,184,184)",
    #                fontWeight = "Bold")
    #         }
    #       },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus.Specialty.Group = colDef(
        name = "Specialty",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left",
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

#### Trend
```{r MSUS Volume Trend Output, echo = FALSE, warning = FALSE, message = FALSE}

volume_trend_specialty_output <- volume_trend_specialty_function("MSUS")

map(unique(volume_trend_specialty_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "% Variance from Daily Avg Volume"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 0, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Mon",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Mon,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "Tue",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Tue,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "Wed",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Wed,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#00aeef',
                lineWidth=3,
                lineColor='#00aeef'
                ) %>%
  hc_add_series(name   = "Thu",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Thu,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_add_series(name   = "Fri",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Fri,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#ffc000',
                lineWidth=3,
                lineColor='#ffc000'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSUS ", x, " - Volume Variance by Day of Week"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Avg Volume by DOW Compared to Daily Avg Weekday Volume",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


### No Shows {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSUS No Show Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('msus_ytd_noshow-download-table', 'Avg No Show Rate')"
    ),

reactable(
  no_show_ytd_site_function("MSUS"),
  elementId = "msus_ytd_noshow-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = "Campus.Specialty.Group",

  columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Visit Volume"), 
             columns = c("Total", "new_perc"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " No Show Rate"), 
             columns = c("noShow_rate", "noShow_rate_Established", "noShow_rate_New"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),

  columns = list(

    Campus.Specialty.Group = colDef(
      name = "Specialty",
      maxWidth = 250),
    
    Department = colDef(
      name = "Department",
      maxWidth = 300),
    

    `noShow_rate_Established` = colDef(
      name = "No Show Rate - Established",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalTotal_Established = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalTotal_Established += row['Total_Established']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established) / totalTotal_Established || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate_New` = colDef(
      name = "No Show Rate - New",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal_New = 0
        rows.forEach(function(row) {
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal_New += row['Total_New']
        })
        return (totalNoShow_New + totalSameDayCanceled_New) / totalTotal_New || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate` = colDef(
      name = "No Show Rate - All",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal += row['Total']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established + totalNoShow_New + totalSameDayCanceled_New) / totalTotal || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    Total = colDef(
      name = "Total Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    new_perc = colDef(
      name = "% New Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal_New += row['Total_New']
          totalTotal += row['Total']
        })
        return (totalTotal_New) / totalTotal
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    

    Arrived_Established = colDef(show =F),
    Arrived_New = colDef(show =F),
    NoShow_Established = colDef(show =F),
    NoShow_New = colDef(show =F),
    `SameDayCanceled_Established` = colDef(show =F),
    `SameDayCanceled_New` = colDef(show =F),
    `SameDayRescheduled_Established` = colDef(show =F),
    `SameDayRescheduled_New` = colDef(show =F),
    `SameDayBump_Established` = colDef(show =F),
    `SameDayBump_New` = colDef(show =F),
    `Total_Established` = colDef(show =F),
    `Total_New` = colDef(show =F),
    `Total` = colDef(show =F),
    Campus = colDef(show =F)

  ) # Close Columns

  ) # Close Reactable

 )
)

```


#### Trend
```{r MSUS No Show Trend, echo = FALSE, warning = FALSE, message = FALSE}

no_show_trend_site_output <- no_show_trend_site_function("MSUS")

map(unique(no_show_trend_site_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "No Show Rate"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 20, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Established",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_Established,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "New",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_New,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "All",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSUS ", x, " - Avg No Show Rate"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Target:",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


## MSW
### Variance by Day of Week {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSW YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_msw_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_site_function("MSW"),
    elementId = "ytd_msw_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    rowStyle = function(index) {
            if (index %in% c(10)) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus = colDef(
        name = "Site",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left"
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

```{r MSW Specialty YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_msw_specialty_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_specialty_function("MSW"),
    elementId = "ytd_msw_specialty_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    # rowStyle = function(index) {
    #         if (index %in% c(10)) {
    #           list(`border-top` = "2px solid rgb(184,184,184)",
    #                fontWeight = "Bold")
    #         }
    #       },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus.Specialty.Group = colDef(
        name = "Specialty",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left",
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

#### Trend
```{r MSW Volume Trend Output, echo = FALSE, warning = FALSE, message = FALSE}

volume_trend_specialty_output <- volume_trend_specialty_function("MSBI")

map(unique(volume_trend_specialty_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "% Variance from Daily Avg Volume"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 0, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Mon",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Mon,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "Tue",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Tue,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "Wed",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Wed,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#00aeef',
                lineWidth=3,
                lineColor='#00aeef'
                ) %>%
  hc_add_series(name   = "Thu",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Thu,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_add_series(name   = "Fri",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Fri,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#ffc000',
                lineWidth=3,
                lineColor='#ffc000'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSW ", x, " - Volume Variance by Day of Week"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Avg Volume by DOW Compared to Daily Avg Weekday Volume",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


### No Shows {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r MSW No Show Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('msw_ytd_noshow-download-table', 'Avg No Show Rate')"
    ),

reactable(
  no_show_ytd_site_function("MSW"),
  elementId = "msw_ytd_noshow-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = "Campus.Specialty.Group",

  columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Visit Volume"), 
             columns = c("Total", "new_perc"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " No Show Rate"), 
             columns = c("noShow_rate", "noShow_rate_Established", "noShow_rate_New"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),

  columns = list(

    Campus.Specialty.Group = colDef(
      name = "Specialty",
      maxWidth = 250),
    
    Department = colDef(
      name = "Department",
      maxWidth = 300),
    

    `noShow_rate_Established` = colDef(
      name = "No Show Rate - Established",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalTotal_Established = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalTotal_Established += row['Total_Established']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established) / totalTotal_Established || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate_New` = colDef(
      name = "No Show Rate - New",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal_New = 0
        rows.forEach(function(row) {
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal_New += row['Total_New']
        })
        return (totalNoShow_New + totalSameDayCanceled_New) / totalTotal_New || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate` = colDef(
      name = "No Show Rate - All",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal += row['Total']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established + totalNoShow_New + totalSameDayCanceled_New) / totalTotal || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    Total = colDef(
      name = "Total Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    new_perc = colDef(
      name = "% New Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal_New += row['Total_New']
          totalTotal += row['Total']
        })
        return (totalTotal_New) / totalTotal
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    

    Arrived_Established = colDef(show =F),
    Arrived_New = colDef(show =F),
    NoShow_Established = colDef(show =F),
    NoShow_New = colDef(show =F),
    `SameDayCanceled_Established` = colDef(show =F),
    `SameDayCanceled_New` = colDef(show =F),
    `SameDayRescheduled_Established` = colDef(show =F),
    `SameDayRescheduled_New` = colDef(show =F),
    `SameDayBump_Established` = colDef(show =F),
    `SameDayBump_New` = colDef(show =F),
    `Total_Established` = colDef(show =F),
    `Total_New` = colDef(show =F),
    `Total` = colDef(show =F),
    Campus = colDef(show =F)

  ) # Close Columns

  ) # Close Reactable

 )
)

```


#### Trend
```{r MSW No Show Trend, echo = FALSE, warning = FALSE, message = FALSE}

no_show_trend_site_output <- no_show_trend_site_function("MSW")

map(unique(no_show_trend_site_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "No Show Rate"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 20, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Established",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_Established,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "New",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_New,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "All",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("MSW ", x, " - Avg No Show Rate"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Target:",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```



## NETWORK
### Variance by Day of Week {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r NETWORK  Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_network_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_site_function("NETWORK"),
    elementId = "ytd_network_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    rowStyle = function(index) {
            if (index %in% c(10)) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus = colDef(
        name = "Site",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left"
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

```{r NETWORK Specialty YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_network_specialty_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_specialty_function("NETWORK"),
    elementId = "ytd_network_specialty_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    # rowStyle = function(index) {
    #         if (index %in% c(10)) {
    #           list(`border-top` = "2px solid rgb(184,184,184)",
    #                fontWeight = "Bold")
    #         }
    #       },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus.Specialty.Group = colDef(
        name = "Specialty",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left",
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

#### Trend
```{r NETWORK Volume Trend Output, echo = FALSE, warning = FALSE, message = FALSE}

volume_trend_specialty_output <- volume_trend_specialty_function("NETWORK")

map(unique(volume_trend_specialty_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "% Variance from Daily Avg Volume"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 0, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Mon",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Mon,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "Tue",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Tue,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "Wed",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Wed,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#00aeef',
                lineWidth=3,
                lineColor='#00aeef'
                ) %>%
  hc_add_series(name   = "Thu",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Thu,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_add_series(name   = "Fri",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Fri,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#ffc000',
                lineWidth=3,
                lineColor='#ffc000'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("NETWORK ", x, " - Volume Variance by Day of Week"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Avg Volume by DOW Compared to Daily Avg Weekday Volume",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


### No Shows {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r NETWORK No Show Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('network_ytd_noshow-download-table', 'Avg No Show Rate')"
    ),

reactable(
  no_show_ytd_site_function("NETWORK"),
  elementId = "network_ytd_noshow-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = "Campus.Specialty.Group",

  columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Visit Volume"), 
             columns = c("Total", "new_perc"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " No Show Rate"), 
             columns = c("noShow_rate", "noShow_rate_Established", "noShow_rate_New"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),

  columns = list(

    Campus.Specialty.Group = colDef(
      name = "Specialty",
      maxWidth = 250),
    
    Department = colDef(
      name = "Department",
      maxWidth = 300),
    

    `noShow_rate_Established` = colDef(
      name = "No Show Rate - Established",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalTotal_Established = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalTotal_Established += row['Total_Established']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established) / totalTotal_Established || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate_New` = colDef(
      name = "No Show Rate - New",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal_New = 0
        rows.forEach(function(row) {
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal_New += row['Total_New']
        })
        return (totalNoShow_New + totalSameDayCanceled_New) / totalTotal_New || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate` = colDef(
      name = "No Show Rate - All",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal += row['Total']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established + totalNoShow_New + totalSameDayCanceled_New) / totalTotal || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    Total = colDef(
      name = "Total Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    new_perc = colDef(
      name = "% New Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal_New += row['Total_New']
          totalTotal += row['Total']
        })
        return (totalTotal_New) / totalTotal
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    

    Arrived_Established = colDef(show =F),
    Arrived_New = colDef(show =F),
    NoShow_Established = colDef(show =F),
    NoShow_New = colDef(show =F),
    `SameDayCanceled_Established` = colDef(show =F),
    `SameDayCanceled_New` = colDef(show =F),
    `SameDayRescheduled_Established` = colDef(show =F),
    `SameDayRescheduled_New` = colDef(show =F),
    `SameDayBump_Established` = colDef(show =F),
    `SameDayBump_New` = colDef(show =F),
    `Total_Established` = colDef(show =F),
    `Total_New` = colDef(show =F),
    `Total` = colDef(show =F),
    Campus = colDef(show =F)

  ) # Close Columns

  ) # Close Reactable

 )
)

```


#### Trend
```{r NETWORK No Show Trend, echo = FALSE, warning = FALSE, message = FALSE}

no_show_trend_site_output <- no_show_trend_site_function("NETWORK")

map(unique(no_show_trend_site_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "No Show Rate"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 20, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Established",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_Established,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "New",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_New,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "All",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("NETWORK ", x, " - Avg No Show Rate"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Target:",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```



## ONCOLOGY
### Variance by Day of Week {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r ONCOLOGY YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_onc_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_site_function("ONCOLOGY"),
    elementId = "ytd_onc_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    rowStyle = function(index) {
            if (index %in% c(10)) {
              list(`border-top` = "2px solid rgb(184,184,184)",
                   fontWeight = "Bold")
            }
          },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus = colDef(
        name = "Site",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left"
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE)
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0)
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

```{r ONCOLOGY Specialty YTD Volume Variance Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output ------------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('ytd_onc_specialty_merged-download-table', 'Avg Volume by DOW and Site')"
    ),
  reactable(
    ytd_total_volume_specialty_function("ONCOLOGY"),
    elementId = "ytd_onc_specialty_merged-download-table",
    # groupBy = c("Campus","Campus.Specialty.Group"),
    # defaultPageSize = 5,
    # elementId = "site-grouping-table",
    style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "center", 
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),  
    # rowStyle = function(index) {
    #         if (index %in% c(10)) {
    #           list(`border-top` = "2px solid rgb(184,184,184)",
    #                fontWeight = "Bold")
    #         }
    #       },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
    # bordered = TRUE,
     # rowStyle = function(index) {
     #        if (index %in% as.vector(col_border_num$total)) {
     #          list(`border-bottom` = "thin solid")
     #        }
     #      },
    columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Total Volume"), 
             columns = c("Mon_total_day", "Tue_total_day", "Wed_total_day", "Thu_total_day", "Fri_total_day"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Avg Volume per Day"), 
             columns = c("Mon_avg_day", "Tue_avg_day", "Wed_avg_day", "Thu_avg_day", "Fri_avg_day"),
             headerStyle = list(color = "#7f7f7f", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Variance from Daily Avg Volume"), 
             columns = c("Mon_var", "Tue_var", "Wed_var", "Thu_var", "Fri_var"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),
    columns = list(
      Campus.Specialty.Group = colDef(
        name = "Specialty",
        minWidth = 200,
        headerStyle = list(background = "white", color = "black", fontWeight = "Bold", fontSize = "14px"),
        style = list(fontWeight = "Bold"),
        align = "left",
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
        # footer = "*Excludes MSDMG and NETWORK"
        ),
      Mon_total_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_total_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_total_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_total_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_total_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_avg_day = colDef(
        name = "Mon",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Tue_avg_day = colDef(
        name = "Tue",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Wed_avg_day = colDef(
        name = "Wed",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Thu_avg_day = colDef(
        name = "Thu",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      Fri_avg_day = colDef(
        name = "Fri",
        minWidth = 100,
        headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
        align = "center",
        format = colFormat(separators = TRUE, digits = 0),
        cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else value
        }
      ),
      blank1 = colDef(
        name = "",
        minWidth = 30
      ),
      Mon_var = colDef(
      name = "Mon",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Tue_var = colDef(
      name = "Tue",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Wed_var = colDef(
      name = "Wed",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Thu_var = colDef(
      name = "Thu",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      ),
      Fri_var = colDef(
      name = "Fri",
      minWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      align = "center",
      format = colFormat(percent = TRUE),
      cell = function(value) {
        if (is.na(value)) "  \u2013 "
        else if (value>0) paste0("+",value*100,"%")
        else paste0(value*100,"%")
      },
      style = function(value) {
        color <- if (is.na(value)) {"#aaa"}
        else if (value > 0) {
          "#008000"
        } else "#e00000"
        list(fontWeight = 600, color = color)
      }
      )
    ) # Close Columns
  ) # Close Reactable
  
  )
)

```
<span style='font-size: 14px; font-style: italic; color: black'>*Data includes business days only; excludes `r holidays`</span><br/>

#### Trend
```{r ONCOLOGY Volume Trend Output, echo = FALSE, warning = FALSE, message = FALSE}

volume_trend_specialty_output <- volume_trend_specialty_function("ONCOLOGY")

map(unique(volume_trend_specialty_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "% Variance from Daily Avg Volume"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 0, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Mon",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Mon,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "Tue",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Tue,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "Wed",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Wed,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#00aeef',
                lineWidth=3,
                lineColor='#00aeef'
                ) %>%
  hc_add_series(name   = "Thu",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Thu,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_add_series(name   = "Fri",
                data   = (volume_trend_specialty_output %>% filter(Campus.Specialty.Group == x))$Fri,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#ffc000',
                lineWidth=3,
                lineColor='#ffc000'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("ONCOLOGY ", x, " - Volume Variance by Day of Week"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Avg Volume by DOW Compared to Daily Avg Weekday Volume",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


### No Shows {.tabset .tabset-fade .tabset-pills}
#### `r current_year` YTD
```{r ONCOLOGY No Show Output, echo = FALSE, warning = FALSE, message = FALSE}

# Table Output -----------------------------------------------------------------
htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('onc_ytd_noshow-download-table', 'Avg No Show Rate')"
    ),

reactable(
  no_show_ytd_site_function("ONCOLOGY"),
  elementId = "onc_ytd_noshow-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = "Campus.Specialty.Group",

  columnGroups = list(
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " Visit Volume"), 
             columns = c("Total", "new_perc"),
             headerStyle = list(color = "#212070", fontSize = "16px")),
    colGroup(name = paste0(format(as.Date(start_date), "%b"),"-",format(as.Date(end_date), "%b %Y"), " No Show Rate"), 
             columns = c("noShow_rate", "noShow_rate_Established", "noShow_rate_New"),
             headerStyle = list(color = "#d80b8c", fontSize = "16px"))
    ),

  columns = list(

    Campus.Specialty.Group = colDef(
      name = "Specialty",
      maxWidth = 250),
    
    Department = colDef(
      name = "Department",
      maxWidth = 300),
    

    `noShow_rate_Established` = colDef(
      name = "No Show Rate - Established",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalTotal_Established = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalTotal_Established += row['Total_Established']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established) / totalTotal_Established || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate_New` = colDef(
      name = "No Show Rate - New",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal_New = 0
        rows.forEach(function(row) {
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal_New += row['Total_New']
        })
        return (totalNoShow_New + totalSameDayCanceled_New) / totalTotal_New || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    `noShow_rate` = colDef(
      name = "No Show Rate - All",
      maxWidth = 150,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNoShow_Established = 0
        let totalSameDayCanceled_Established = 0
        let totalNoShow_New = 0
        let totalSameDayCanceled_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalNoShow_Established += row['NoShow_Established']
          totalSameDayCanceled_Established += row['SameDayCanceled_Established']
          totalNoShow_New += row['NoShow_New']
          totalSameDayCanceled_New += row['SameDayCanceled_New']
          totalTotal += row['Total']
        })
        return (totalNoShow_Established + totalSameDayCanceled_Established + totalNoShow_New + totalSameDayCanceled_New) / totalTotal || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    Total = colDef(
      name = "Total Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    
    new_perc = colDef(
      name = "% New Visits",
      maxWidth = 150,
      headerStyle = list(background = "#210070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_New = 0
        let totalTotal = 0
        rows.forEach(function(row) {
          totalTotal_New += row['Total_New']
          totalTotal += row['Total']
        })
        return (totalTotal_New) / totalTotal
      }"),
      format = colFormat(percent = TRUE, digits = 0),
      style = list(borderLeft = "1.5px solid rgb(230, 230, 230)")
    ),
    

    Arrived_Established = colDef(show =F),
    Arrived_New = colDef(show =F),
    NoShow_Established = colDef(show =F),
    NoShow_New = colDef(show =F),
    `SameDayCanceled_Established` = colDef(show =F),
    `SameDayCanceled_New` = colDef(show =F),
    `SameDayRescheduled_Established` = colDef(show =F),
    `SameDayRescheduled_New` = colDef(show =F),
    `SameDayBump_Established` = colDef(show =F),
    `SameDayBump_New` = colDef(show =F),
    `Total_Established` = colDef(show =F),
    `Total_New` = colDef(show =F),
    `Total` = colDef(show =F),
    Campus = colDef(show =F)

  ) # Close Columns

  ) # Close Reactable

 )
)

```


#### Trend
```{r ONCOLOGY No Show Trend, echo = FALSE, warning = FALSE, message = FALSE}

no_show_trend_site_output <- no_show_trend_site_function("ONCOLOGY")

map(unique(no_show_trend_site_output$Campus.Specialty.Group), function(x){
highchart() %>%
  hc_yAxis_multiples(
    # list(title = list(text = "Avg Volume per Day"), lineWidth = 3),
    list(title = list(text = "No Show Rate"), lineWidth = 3, 
         labels = list(format = '{value}%'),
         plotLines = list(list(value = 20, color = "red", width = 2,
                               dashStyle = "shortdash")))
           # showLastLabel = FALSE, opposite = TRUE)
  ) %>%
  hc_xAxis(title = list(text = ""),
           categories = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$Appt.MonthYear,
           type = "datetime",
           labels = list(format = '{value:%Y-%m}')
           # dateTimeLabelFormats = list(month = '%Y-%m')
           ) %>%
  # hc_add_series(name = "Total Visits",
  #               data = (volume_trend_mshs %>% filter(Campus == x))$avg_vol_all,
  #               type = 'column',
  #               color='#212070',
  #               dataLabels = list(enabled = TRUE, format='{point.y}')) %>%
  hc_add_series(name   = "Established",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_Established,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#212070',
                lineWidth=3,
                lineColor='#212070'
                ) %>%
  hc_add_series(name   = "New",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate_New,
                type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#d80b8c',
                lineWidth=3,
                lineColor='#d80b8c'
                ) %>%
  hc_add_series(name   = "All",
                data   = (no_show_trend_site_output %>% filter(Campus.Specialty.Group == x))$noShow_rate,
               type = 'line', 
                # color = '#a5a7a5'
                marker = list(enabled= TRUE),
                color='#7f7f7f',
                lineWidth=3,
                lineColor='#7f7f7f'
                ) %>%
  hc_legend(align = "left", verticalAlign = "top", itemStyle = list(fontFamily ='Calibri',color ='black', fontSize = "14px")) %>%
  hc_title(text = paste0("ONCOLOGY ", x, " - Avg No Show Rate"), align = "left", style = list(fontWeight = 'bold', fontSize = "22px", fontFamily = "Calibri")) %>%
  hc_subtitle(text = "Target:",
              align = "left", style = list(fontFace = "italic", fontSize = "16px", fontFamily = "Calibri")) %>%
    hc_tooltip(shared = TRUE, borderColor = "black")
  }) %>%
  hw_grid(ncol = 2, rowheight = 400) %>% htmltools::browsable()

```


